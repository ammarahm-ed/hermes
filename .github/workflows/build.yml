name: facebook/hermes/build
on: workflow_dispatch

jobs:
  android:
    runs-on: ubuntu-latest
    env:
      HERMES_WS_DIR: ${{ github.workspace }}
    steps:
    - name: Set up workspace and install dependencies
      run: |-
        yes | sdkmanager "cmake;3.22.1" &
        sudo apt update && sudo apt install -y libicu-dev
    - uses: actions/checkout@v4.1.0
      with:
        path: hermes
    - name: Build Hermes Compiler
      run: |-
        cmake -S hermes -B build
        # Build the Hermes compiler so that the cross compiler build can
        # access it to build the VM
        cmake --build ./build --target hermesc -j 4
    - name: Build Hermes for Android
      run: |-
        cd hermes/android
        ./gradlew githubRelease
    - name: Copy artifacts
      run: |-
        mkdir output
        cp build_android/distributions/hermes-runtime-android-*.tar.gz output
    - name: Checksum artifacts
      run: |-
        cd output
        for file in *
        do
          sha256sum "$file" > "$file.sha256"
        done
    - uses: actions/upload-artifact@v4.3.1
      with:
        name: android-hermes
        path: output
